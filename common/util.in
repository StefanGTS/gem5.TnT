#! /bin/bash

# Copyright (c) 2017, University of Kaiserslautern
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#
# 1. Redistributions of source code must retain the above copyright notice,
#    this list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER
# OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# Author: Ã‰der F. Zulian

# Colors
readonly Black='\033[0;30m'
readonly Red='\033[0;31m'
readonly Green='\033[0;32m'
readonly Brown='\033[0;33m'
readonly Blue='\033[0;34m'
readonly Purple='\033[0;35m'
readonly Cyan='\033[0;36m'
readonly LightGray='\033[0;37m'
readonly DarkGray='\033[1;30m'
readonly LightRed='\033[1;31m'
readonly LightGreen='\033[1;32m'
readonly Yellow='\033[1;33m'
readonly LightBlue='\033[1;34m'
readonly LightPurple='\033[1;35m'
readonly LightCyan='\033[1;36m'
readonly White='\033[1;37m'
readonly NC='\033[0m'

# Functions

abort() {
	echo -e -n "\n\033[31mAborting.\n"; exit
}

cmdtest() {
	hash $@ 2>/dev/null || { echo >&2 "\"$@\" could not be found. Please install it and try again."; abort; }
}

rctest() {
	local cmdline="$@"
	local cmd="${cmdline%% *}"
	cmdtest $cmd
	"$@"
	local status=$?
	if [ $status -ne 0 ]; then
		echo -e -n "\n\033[31mError executing \"$@\".\n" >&2; echo -en "\e[0m"; abort;
	fi
	return $status
}

archdetect() {
	local arch=$(uname -m | sed 's/x86_//;s/i[3-6]86/32/')
	hash notify-send 2> /dev/null
	if [[ $? -eq 0 ]]; then
		notify-send "Architecture is ${arch}-bit"
	fi
	echo -e "Architecture is ${arch}-bit"
}

chessit() {
	local nr=1
	local nc=80
	echo ""
	for (( r = 0; r < $nr; r++ ))
	do
		for (( c = 0 ; c < $nc; c++ ))
		do
			local sqrs=`expr $r + $c`
			local odd=`expr $sqrs % 2`
			if [ $odd -eq 0 ]; then
				echo -e -n "\033[47m "
			else
				echo -e -n "\033[40m "
			fi
		done
		echo -e -n "\033[40m" && echo ""
	done
}

greetings() {
	chessit
	echo ""
	archdetect
	rctest date
	if [ "$EUID" -ne 0 ]; then
		local msg="Greetings $USER!"
		hash cowsay 2> /dev/null
		if [[ $? -eq 0 ]]; then
			cmd="cowsay -f tux $msg"
			rctest $cmd
		else
			echo -e "$msg"
		fi
	fi
	echo ""
	echo -e -n "You're currently on $HOSTNAME" && echo ""
	echo -e -n "Your home folder is $HOME" && echo ""
	echo -e -n "The current directory is $PWD" && echo ""
	echo ""
}

checkprivledges() {
	if [ "$EUID" -ne 0 ]; then
		msg="Superuser priviledges are needed in order to perform\
		some operations"
		echo -e -n $msg && echo ""
		echo "Please run as root"
		exit
	fi
}

wgetintodir() {
	cmdtest wget
	declare -a argarray=("${!1}")
	for e in "${argarray[@]}"; do
		local c="mkdir -p ${e%%:*}"
		rctest $c
		wget -N ${e#*:} -P ${e%%:*}
	done
}

hgcloneintodir() {
	cmdtest hg
	declare -a argarray=("${!1}")
	for e in "${argarray[@]}"; do
		local c="mkdir -p ${e%%,*}"
		rctest $c
		cd ${e%%,*}
		hg clone ${e#*,}
		echo -e -n "${e#*,} cloned into ${e%%,*}" && echo ""
	done
}

gitcloneintodir() {
	cmdtest git
	declare -a argarray=("${!1}")
	for e in "${argarray[@]}"; do
		local c="mkdir -p ${e%%:*}"
		rctest $c
		cd ${e%%:*}
		git clone --recursive ${e#*:}
		echo -e -n "${e#*:} cloned into ${e%%:*}" && echo ""
	done
}

getnumprocs() {
	local __retvar=$1;
	local __nprocs=$(cat /proc/cpuinfo | grep processor | wc -l)
	if [[ "$__retvar" ]]; then
		eval $__retvar="'$__nprocs'"
	else
		echo "$__nprocs"
	fi
}

build() {
	local target=$1
	local buildopts=$2
	getnumprocs np
	local njobs=`expr $np - 1`
	scons $buildopts $target -j$njobs
	if [[ -e $target ]]; then
		printf "\n${Red}Target successfully built${NC}\n"
		file $target
		printf "\n"
	fi
}

build_gem5() {
	local arch=$1
	local mode=$2
	local target="build/$arch/gem5.$mode"
	build $target
}

build_libgem5() {
	local arch=$1
	local mode=$2
	local target="build/$arch/libgem5_$mode.so"
	local buildopts="--with-cxx-config --without-python --without-tcmalloc"
	build $target $buildopts
}

