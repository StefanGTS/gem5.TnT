## gem5 Tips & Tricks
### **Running android on gem5**

Here you'll find an example on how to get android up and running on gem5.

Make sure everything is setup! You're all done if you followed [**the steps described here**](../../../README.md).

Oh, one last thing, if you haven't yet built gem5 check [**this**](../../../doc/Gem5Basics.md).

Apply one of the patches to your gem5 source code.

```bash
$ cd $HOME/gem5_tnt/gem5
$ patch -p1 < $HOME/gem5.TnT/patches/gem5/asimbench/gem5_ARMv7a-ICS-Android.SMP.Asimbench-v3.patch
```

After applying the patch you have to build gem5 again. But don't worry, this time the build process will finish much faster than the first build.

Export the gem5 binary and some gem5 configurations as environment variables.

```bash
$ export GEM5_ELF="build/ARM/gem5.opt"
$ export CPU_OPTIONS="--cpu-type=TimingSimpleCPU --num-cpu=4"
$ export MACHINE_TYPE="--machine-type=RealView_PBX"
$ export OS_OPTIONS="--os-type=android-ics"
$ export KERNEL="--kernel=vmlinux.smp.ics.arm.asimbench.2.6.35"
$ export FS_SCRIPT="configs/example/fs.py"
$ export MEM_OPTIONS="--mem-size=256MB --mem-type=DDR3_1600_8x8 --mem-channels=2 --caches --l2cache"
$ export OTHER_OPTIONS="--frame-capture"
```

Choose the benchmark script, the disk image that contains the benchmark
program and the output directory that will be generated by gem5.

```bash
$ export BENCHMARK_OPTIONS="--script=bbench.rcS"
$ export DISK="--disk=ARMv7a-ICS-Android.SMP.Asimbench-v3.img"
$ export OUT_DIR="--outdir=android_asimbench_output"
```

Or you can use a clean android disk image without any benchmark program.

```bash
$ export BENCHMARK_OPTIONS=""
$ export DISK="--disk=ARMv7a-ICS-Android.SMP.nolock.clean.img"
$ export OUT_DIR="--outdir=android_clean_output"
```

Run gem5.

```bash
$ $GEM5_ELF $OUT_DIR $FS_SCRIPT $CPU_OPTIONS $MEM_OPTIONS $BENCHMARK_OPTIONS $MACHINE_TYPE $KERNEL $DISK $OS_OPTIONS $OTHER_OPTIONS
```

Connect with **m5term**.

```bash
$ cd util/term
$ make
$ ./m5term localhost 3456
```

Connect with **vncviewer**.

```bash
$ vncviewer localhost:5901
```

A convenient script [**run_arm_fs_android_ics.sh**](../../../arch/arm/run_arm_fs_android_ics.sh) is provided.

#### References:

https://bitbucket.org/yongbing_huang/asimbench

http://www.gem5.org/BBench-gem5
